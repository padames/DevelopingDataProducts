---
title: "USA fatalities due to tornados and high winds from 1950 to 2011"
author: "By padames"
date: "March 19, 2017"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE}
library(leaflet)
#load storm data as df
load(file="./usa_storm_data.RData")
#Testing that there is actually data to work with:
#df[df$EVT_TYPE == "Hurricanes/Tornados/Thunderstorms" & df$FATALITIES > 100,][c('STATE','LATITUDE','LONGITUDE')]

years_string <- (as.character.Date(df$BGN_DATE,format="%d/%m/%Y"))
dates <- as.POSIXlt(years_string,format = "%d/%M/%Y")
rm(years_string)
dfMod <- transform( df, DATE=dates)
rm(dates)
rm(df)

GetStateStormData <- function( stormDataFrame, EffectName, EventType, cutOffLabels=1.0) {
    ## stormDataFrame, EffectName=exact data frame column heading
    ## Subset the storm.data.frame
    #storm_data_ST <- stormDataFrame[stormDataFrame$STATE == ST,]
    storm_data_ST_EvtType <- stormDataFrame[ stormDataFrame$EVT_TYPE == EventType
                                            & stormDataFrame[EffectName]>=1,]
    
    df <- storm_data_ST_EvtType[storm_data_ST_EvtType$LATITUDE > 0 & storm_data_ST_EvtType$LONGITUDE > 0,]
    dfMod <- transform( df, LATITUDE=df$LATITUDE/100, LONGITUDE=-df$LONGITUDE/100)
}

GenerateFatalityLabels <- function(df){
  yearsTornados <-as.character(strftime(as.Date.factor(df$BGN_DATE,format= "%d/%m/%Y"), 
                                        "%Y-%b-%d"))
  labels <- mapply(FUN=function(x,y,z) paste(sep=" ", 
                                   ifelse(is.na(y), "No date: ", paste0(y, ": ")), 
                                   paste0(z, " ", as.character(x),
                                          ifelse(x<2," fatality"," fatalities"))),
         df$FATALITIES, 
         yearsTornados, 
         df$EVTYPE )
  l <- unlist(labels)
  
}


dfFatalities <- GetStateStormData(dfMod,"FATALITIES","Hurricanes/Tornados/Thunderstorms")

years <-as.character(as.Date(dfFatalities$DATE,format= "%d/%m/%Y"),"%Y-%b-%d")
popup_labels <- mapply(FUN=function(x,y,z) paste(sep=" ", 
                                                 ifelse(is.na(y), "No date: ", paste0(y, ": ")), 
                                                 paste0(z, " ", as.character(x),
                                                        ifelse(x<2," fatality"," fatalities"))),
                       dfFatalities$FATALITIES, 
                       years, 
                       dfFatalities$EVTYPE)

dfFatalities$Label <- popup_labels

dfFatalTornados <- dfFatalities[dfFatalities$EVTYPE=="TORNADO",]
dfFatalHighWind <- dfFatalities[dfFatalities$EVTYPE=="HIGH WIND",]
dfFatalThunderWind <- dfFatalities[dfFatalities$EVTYPE=="THUNDERSTORM WIND",]
dfFatalMarineWind <- dfFatalities[(dfFatalities$EVTYPE=="MARINE STRONG WIND") | (dfFatalities$EVTYPE == "MARINE THUNDERSTORM WIND"),]

leaflet() %>% 
  addTiles() %>% 
  addMarkers(data= dfFatalTornados,
             lat = ~ LATITUDE, 
             lng = ~ LONGITUDE, 
             label = ~ Label,
             labelOptions = labelOptions(noHide = F, textsize = "12px"),
             clusterOptions = markerClusterOptions(),
             group = "Tornados") %>%
  addMarkers(data= dfFatalHighWind,
             lat = ~ LATITUDE, 
             lng = ~ LONGITUDE, 
             label = ~ Label,
             labelOptions = labelOptions(noHide = F, textsize = "12px"),
             clusterOptions = markerClusterOptions(),
             group = "High Winds") %>%
  addMarkers(data= dfFatalThunderWind,
             lat = ~ LATITUDE, 
             lng = ~ LONGITUDE, 
             label = ~ Label,
             labelOptions = labelOptions(noHide = F, textsize = "12px"),
             clusterOptions = markerClusterOptions(),
             group = "Thunderstorms") %>%
  addMarkers(data= dfFatalMarineWind,
             lat = ~ LATITUDE, 
             lng = ~ LONGITUDE, 
             label = ~ Label,
             labelOptions = labelOptions(noHide = F, textsize = "12px"),
             clusterOptions = markerClusterOptions(),
             group = "Marine Winds") %>%  
  addLayersControl(
    overlayGroups=c("Tornados","High Winds","Thunderstorms","Marine winds"),
    options=layersControlOptions(collapsed=FALSE))
```

The storm data was collected by Dr. Roger Peng from a public data base of the U.S. National Oceanic and Atmospheric Administration (NOAA) and provided to students of the Reproducible Reserach Course. It was downloaded in November, 2014 from
[compressed file](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2). 
Additional code was added to filter the fatality data for the Tornado and high wind storm events.

